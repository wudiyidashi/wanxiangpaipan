name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒ
    runs-on: macos-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: å®‰è£…ä¾èµ–
        run: flutter pub get

      - name: ä»£ç ç”Ÿæˆ
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: è¿è¡Œæµ‹è¯•
        run: flutter test

      - name: æ„å»º APK (Release)
        run: flutter build apk --release

      - name: æ„å»º App Bundle (Release)
        run: flutter build appbundle --release

      - name: æ„å»º iOS (Release)
        run: flutter build ios --release --no-codesign

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          body: |
            ## ğŸ‰ ä¸‡è±¡æ’ç›˜ ${{ steps.get_version.outputs.VERSION }}

            ### ğŸ“¦ ä¸‹è½½

            - **Android APK**: é€‚ç”¨äº Android 5.0 åŠä»¥ä¸Š
            - **Android App Bundle**: ç”¨äº Google Play å‘å¸ƒ

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

            ### ğŸ” æ ¡éªŒå’Œ

            æ–‡ä»¶æ ¡éªŒå’Œå°†åœ¨æ„å»ºå®Œæˆåç”Ÿæˆã€‚
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… å‘å¸ƒ ${{ steps.get_version.outputs.VERSION }} æˆåŠŸï¼"
          echo "ğŸ“¦ å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}"
